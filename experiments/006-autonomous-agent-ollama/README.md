# Experiment 004: Autonomous Agent with Ollama

## Overview
This experiment implements and tests the self-aware autonomous agent mode described in the AUTONOMOUS_MODE_DESIGN.md, using Ollama as the LLM backend. It demonstrates both curl and Emacs integration for agent-based task execution.

## Key Features
- Self-aware agent prompting with structured JSON responses
- Mixed action types: shell commands and Elisp evaluation
- TODO-driven task management
- Both curl and Emacs implementation examples

## Files
- `test-autonomous-agent.sh` - Comprehensive test script with curl and Emacs examples
- `test-autonomous-agent.el` - Pure Elisp implementation (generated by script)
- `README.md` - This documentation

## Quick Start

### Run the test suite
```bash
cd experiments/004-autonomous-agent-ollama
./test-autonomous-agent.sh
```

This will:
1. Test agent planning phase with curl
2. Generate action execution signals
3. Create pure Elisp code for actions
4. Demonstrate Emacs integration
5. Show both JSON-structured and raw responses

## Agent Protocol

### Request Structure
The agent uses a specific system prompt to maintain self-awareness:
```
You are Efrit, an autonomous Emacs agent. You maintain a TODO list and work 
systematically toward goals. You have access to elisp evaluation, shell commands, 
and file operations.
```

### Response Format
```json
{
  "status": "planning|executing|reflecting|stuck|complete",
  "todos": [
    {"id": 1, "status": "pending", "priority": "high"}
  ],
  "next_action": {
    "type": "eval|shell|file_read",
    "content": "(command-here)",
    "rationale": "explanation"
  },
  "self_assessment": "current understanding",
  "completion_estimate": "N actions remaining"
}
```

## Action Types

1. **eval** - Execute Elisp code
   ```json
   {"type": "eval", "content": "(buffer-name)"}
   ```

2. **shell** - Run shell commands
   ```json
   {"type": "shell", "content": "git status"}
   ```

3. **file_read** - Read file contents
   ```json
   {"type": "file_read", "content": "/path/to/file"}
   ```

## Example Usage

### Curl Example
```bash
curl -s -X POST http://localhost:11434/api/generate \
  -H "Content-Type: application/json" \
  -d '{
    "model": "qwen2.5-coder:7b",
    "prompt": "Current Goal: Update packages\nSession State: Starting\n",
    "system": "You are Efrit, an autonomous agent...",
    "format": "json",
    "temperature": 0.3
  }'
```

### Emacs Example
```elisp
(load-file "test-autonomous-agent.el")
(efrit-agent-demo)  ; Run full demo
(efrit-agent-query "Check package versions" "Initial state")  ; Single query
```

## Test Results
- ✅ Agent maintains self-awareness across queries
- ✅ Generates valid JSON with proper structure
- ✅ Creates executable Elisp code
- ✅ Produces actionable shell commands
- ✅ Tracks progress with TODO items

## Observations

### Strengths
1. Model successfully understands agent role
2. Consistent JSON structure in responses
3. Reasonable action planning and rationales
4. Good mix of action types based on context

### Limitations
1. Pure Elisp generation sometimes includes markdown formatting
2. Temperature needs tuning (0.1-0.3 works best)
3. Complex multi-step reasoning may require prompt refinement

## Future Improvements
- [ ] Implement action execution loop
- [ ] Add session state persistence
- [ ] Create reflection/learning mechanism
- [ ] Handle stuck states with user input
- [ ] Integrate with main efrit-agent.el

## Configuration
```bash
# Set Ollama host (default: localhost:11434)
export OLLAMA_HOST=http://localhost:11434

# Model selection (auto-detected, prefers qwen2.5-coder)
# Override by editing MODEL variable in script
```

## Related Files
- `/plans/AUTONOMOUS_MODE_DESIGN.md` - Original design specification
- `/experiments/001-ollama-elisp-only/` - Pure Elisp generation experiment
- `/lisp/efrit-agent.el` - Main agent implementation (WIP)